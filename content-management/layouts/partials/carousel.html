{{/*
  carousel.html

  Params (dict):
    - Title: string (heading text)
    - Card: string (singular card name, e.g. "story")
    - Items: sequence of page objects to render

  This partial pluralizes Card (basic rule) and replaces occurrences of
  "stories" in classnames/headings with the pluralized card name.
*/}}
{{ $title := .Title | default "Items" }}
{{ $card := .Card | default "story" }}
{{ $cardCssClass := .CardCssClass | default "" }}
{{ $items := .Items }}
{{ if not $items }}{{ return }}{{ end }}

{{/* basic pluralization: if word ends with consonant+y -> replace y->ies, else add 's' */}}
{{ $last := substr $card (sub (len $card) 1) }}
{{ $vowels := "aeiou" }}
{{ $cardPlural := cond (and (eq $last "y") (not (in $vowels (lower $last)))) (printf "%sies" (substr $card 0 (sub (len $card) 1))) (printf "%ss" $card) }}

{{/* wrapper class and ids */}}
{{ $wrapperClass := printf "%s-carousel-container" $cardPlural }}
{{ $trackId := printf "carousel-track-%s" $cardPlural }}

<script>
  
// Initialize carousel on all pages
document.addEventListener('DOMContentLoaded', function() {
    initFeaturedCarousel();
});

// Featured Stories Carousel
function initFeaturedCarousel() {
    console.log('Initializing carousel...'); // Debug log
  const carousel = document.querySelector('.{{ $wrapperClass }}');
    if (!carousel) {
        console.log('No carousel found');
        return;
    }
    
  const track = carousel.querySelector('#{{ $trackId }}');
  const slides = track ? track.querySelectorAll('.carousel-slide') : [];
  const prevBtn = carousel.querySelector('.carousel-prev');
  const nextBtn = carousel.querySelector('.carousel-next');
  const indicators = carousel.querySelectorAll('.indicator');
    
    console.log('Carousel elements:', { track, slides: slides.length, prevBtn, nextBtn, indicators: indicators.length });
    
    let currentSlide = 0;
    const totalSlides = slides.length;
    
    if (totalSlides <= 1) {
        console.log('Not enough slides for carousel');
        return;
    }
    
    function updateCarousel() {
        console.log('Updating carousel to slide:', currentSlide);
        // Update slides
        slides.forEach((slide, index) => {
            slide.classList.toggle('active', index === currentSlide);
        });
        
        // Update indicators
        indicators.forEach((indicator, index) => {
            indicator.classList.toggle('active', index === currentSlide);
        });
        
        // Transform the track
        const translateX = -currentSlide * 100;
        track.style.transform = `translateX(${translateX}%)`;
    }
    
    function nextSlide() {
        console.log('Next slide clicked');
        currentSlide = (currentSlide + 1) % totalSlides;
        updateCarousel();
    }
    
    function prevSlide() {
        console.log('Previous slide clicked');
        currentSlide = (currentSlide - 1 + totalSlides) % totalSlides;
        updateCarousel();
    }
    
    function goToSlide(slideIndex) {
        console.log('Going to slide:', slideIndex);
        currentSlide = slideIndex;
        updateCarousel();
    }
    
    // Event listeners
    if (nextBtn) {
        nextBtn.addEventListener('click', nextSlide);
        console.log('Next button listener added');
    }
    if (prevBtn) {
        prevBtn.addEventListener('click', prevSlide);
        console.log('Previous button listener added');
    }
    
    indicators.forEach((indicator, index) => {
        indicator.addEventListener('click', () => goToSlide(index));
    });
    
    // Auto-play carousel (optional)
    let autoPlayInterval;
    function startAutoPlay() {
        // Always clear existing interval before starting new one
        stopAutoPlay();
        autoPlayInterval = setInterval(nextSlide, 5000); // Change slide every 5 seconds
    }
    
    function stopAutoPlay() {
        if (autoPlayInterval) {
            clearInterval(autoPlayInterval);
            autoPlayInterval = null; // Clear the reference
        }
    }
    
    // Start auto-play
    startAutoPlay();
    
    // Pause auto-play on hover
    carousel.addEventListener('mouseenter', stopAutoPlay);
    carousel.addEventListener('mouseleave', startAutoPlay);
    
    // Pause auto-play when user interacts
    let resumeTimeout;
    [prevBtn, nextBtn, ...indicators].forEach(element => {
        if (element) {
            element.addEventListener('click', () => {
                stopAutoPlay();
                // Clear any existing resume timeout
                if (resumeTimeout) {
                    clearTimeout(resumeTimeout);
                }
                // Resume after 10 seconds
                resumeTimeout = setTimeout(startAutoPlay, 10000);
            });
        }
    });
    
    // Keyboard navigation
  document.addEventListener('keydown', (e) => {
    if (carousel.matches(':hover') || document.activeElement.closest('.{{ $wrapperClass }}')) {
            if (e.key === 'ArrowLeft') {
                e.preventDefault();
                prevSlide();
            } else if (e.key === 'ArrowRight') {
                e.preventDefault();
                nextSlide();
            }
        }
    });
    
    console.log('Carousel initialized successfully');
}
</script>

<style>
/* Carousel container (per-card type) */
/* wrapper margin moved into .carousel-container to avoid template tags in CSS */

.carousel-container {
    margin-top: 1.5rem;
    position: relative;
    overflow: hidden;
    border-radius: 12px;
    background: rgba(255, 255, 255, 0.1);
    -webkit-backdrop-filter: blur(10px);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
}

.carousel-track {
    display: flex;
    transition: transform 0.5s ease-in-out;
    width: 100%;
}

.carousel-slide {
    min-width: 100%;
    opacity: 0.7;
    transition: opacity 0.5s ease-in-out;
    padding: 2rem;
}

.carousel-slide.active {
    opacity: 1;
}

.carousel-slide .story-card {
    margin: 0;
    background: transparent;
    box-shadow: none;
    border: none;
    padding: 0;
}

.carousel-btn {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(255, 255, 255, 0.9);
    border: none;
    border-radius: 50%;
    width: 48px;
    height: 48px;
    font-size: 1.5rem;
    font-weight: bold;
    color: #333;
    cursor: pointer;
    transition: all 0.3s ease;
    z-index: 10;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
}

.carousel-btn:hover {
    background: white;
    transform: translateY(-50%) scale(1.1);
    box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
}

.carousel-prev {
    left: 1rem;
}

.carousel-next {
    right: 1rem;
}

.carousel-indicators {
    display: flex;
    justify-content: center;
    gap: 0.5rem;
    margin-top: 1rem;
    padding-bottom: 1rem;
}

.indicator {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: none;
    background: rgba(255, 255, 255, 0.5);
    cursor: pointer;
    transition: all 0.3s ease;
}

.indicator.active {
    background: white;
    transform: scale(1.2);
}

.indicator:hover {
    background: rgba(255, 255, 255, 0.8);
}

/* Responsive carousel adjustments */
@media (max-width: 768px) {
    .carousel-slide {
        padding: 1.5rem;
    }
    
    .carousel-btn {
        width: 40px;
        height: 40px;
        font-size: 1.25rem;
    }
    
    .carousel-prev {
        left: 0.5rem;
    }
    
    .carousel-next {
        right: 0.5rem;
    }
}

@media (max-width: 480px) {
    .carousel-slide {
        padding: 1rem;
    }
    
    .carousel-btn {
        width: 36px;
        height: 36px;
        font-size: 1.1rem;
    }
}

</style>

<div class="{{ $wrapperClass }}">
  <h3>{{ $title }}</h3>
  <div class="{{ $cardPlural }}-carousel">
    <div class="carousel-container">
      <div class="carousel-track" id="{{ $trackId }}">
        {{ range $index, $item := $items }}
          {{- $cssClass := printf "%s carousel-slide" $cardCssClass -}}
          {{- if eq $index 0 -}}
            {{- $cssClass = printf "%s active" $cssClass -}}
          {{- end -}}
          {{ partial (printf "%s-card.html" $card) (dict "Page" $item "cssClass" $cssClass) }}
        {{ end }}
      </div>
      {{ if gt (len $items) 1 }}
        <button class="carousel-btn carousel-prev" aria-label="Previous {{ $cardPlural }}">‹</button>
        <button class="carousel-btn carousel-next" aria-label="Next {{ $cardPlural }}">›</button>
      {{ end }}
    </div>
    {{ if gt (len $items) 1 }}
      <div class="carousel-indicators">
        {{ range $index, $item := $items }}
          <button class="indicator {{ if eq $index 0 }}active{{ end }}" data-slide="{{ $index }}" aria-label="Go to {{ $card }} {{ add $index 1 }}"></button>
        {{ end }}
      </div>
    {{ end }}
  </div>
</div>
