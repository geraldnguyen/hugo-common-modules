{{- /*
Generic taxonomy listing shortcode
Usage: {{< taxonomy-list-by-count taxonomy="genres" >}}
*/ -}}

{{- $taxonomy := .Get "taxonomy" | default "genres" -}}
{{- $terms := dict -}}

{{- range where .Site.RegularPages "Section" "stories" -}}
  {{- $params := index .Params $taxonomy -}}
  {{- if $params -}}
    {{- range $params -}}
      {{- $term := . -}}
      {{- $count := index $terms $term | default 0 -}}
      {{- $terms = merge $terms (dict $term (add $count 1)) -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- $termsList := slice -}}
{{- range $term, $count := $terms -}}
  {{- $termsList = $termsList | append (dict "name" $term "count" $count) -}}
{{- end -}}
{{- $sortedTerms := sort $termsList "count" "desc" -}}

<div class="{{ $taxonomy }}-list taxonomy-list">
  {{- range $index, $item := $sortedTerms -}}
    {{- $termSlug := $item.name | urlize -}}
    {{- $termPage := $.Site.GetPage (printf "/%s/%s" $taxonomy $termSlug) -}}
    <div class="taxonomy-item">
      <div class="taxonomy-header">
        {{- if $termPage -}}
          <h3><a href="{{ $termPage.RelPermalink }}">{{ $item.name }}</a></h3>
        {{- else -}}
          <h3>{{ $item.name }}</h3>
        {{- end -}}
        <span class="story-count">{{ $item.count }} {{ if eq $item.count 1 }}story{{ else }}stories{{ end }}</span>
      </div>
      {{- if $termPage -}}
        {{- with $termPage.Params.description }}
          <p class="taxonomy-description">{{ . }}</p>
        {{- end }}
        <a href="{{ $termPage.RelPermalink }}" class="read-more">Explore {{ $item.name }} stories â†’</a>
      {{- end -}}
    </div>
  {{- end -}}
</div>

<style>
.taxonomy-list {
  display: grid;
  gap: 1.5rem;
  margin: 2rem 0;
}
.taxonomy-item {
  border: 1px solid #e0e0e0;
  border-radius: 8px;
  padding: 1.5rem;
  background: #fafafa;
  transition: box-shadow 0.2s ease;
}
.taxonomy-item:hover {
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
.taxonomy-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 0.5rem;
  flex-wrap: wrap;
  gap: 0.5rem;
}
.taxonomy-header h3 {
  margin: 0;
  font-size: 1.25rem;
}
.taxonomy-header h3 a {
  color: #2c3e50;
  text-decoration: none;
}
.taxonomy-header h3 a:hover {
  color: #3498db;
}
.story-count {
  background: #3498db;
  color: white;
  padding: 0.25rem 0.75rem;
  border-radius: 15px;
  font-size: 0.9rem;
  font-weight: 500;
}
.taxonomy-description {
  color: #666;
  margin: 0.5rem 0 1rem 0;
  line-height: 1.5;
}
.read-more {
  color: #3498db;
  text-decoration: none;
  font-weight: 500;
}
.read-more:hover {
  color: #2980b9;
  text-decoration: underline;
}
@media (max-width: 768px) {
  .taxonomy-header {
    flex-direction: column;
    align-items: flex-start;
  }
  .story-count {
    align-self: flex-end;
  }
}
</style>
