{{- /*
  Partial: illustration.html

  Renders a tab UI with these possible tabs (in order):
  - Image (always present) -> shows illustration.webp image
  - Youtube (if .Page.Params.youtube_video_id is set)
  - Facebook Reel (if .Page.Params.facebook_video_id is set)

  Default tab: site.Params.page_illustration_default (values: "image", "youtube", "facebook").
  Falls back to "image" when the configured default isn't available.

  Notes: This partial renders players inline (does not call shortcode-context partials),
  so it is safe to include from templates.
*/ -}}

{{- $page := . -}}
{{- $params := site.Params -}}

{{- $hasYou := and (ne (index $page "Page") nil) (ne $page.Page.Params.youtube_video_id "") -}}
{{- $hasFB  := and (ne (index $page "Page") nil) (ne $page.Page.Params.facebook_video_id "") -}}

{{- /* Fallback-safe access to page params when called from templates */ -}}
{{- $youtubeID := "" -}}
{{- $facebookID := "" -}}
{{- if ne (index $page "Page") nil -}}
  {{- $youtubeID = $page.Page.Params.youtube_video_id -}}
  {{- $facebookID = $page.Page.Params.facebook_video_id -}}
{{- end -}}

{{- $available := slice "image" -}}
{{- if $youtubeID }}
  {{- $available = $available | append "youtube" -}}
{{- end -}}
{{- if $facebookID }}
  {{- $available = $available | append "facebook" -}}
{{- end -}}

{{- $default := (or $params.page_illustration_default "image") | lower -}}
{{- if not (in $available $default) -}}
  {{- $default = "image" -}}
{{- end -}}

{{- $uid := replaceRE `[^a-zA-Z0-9_-]` "-" (or (print $page.File.Path) (printf "illustration-%d" (now.Unix))) -}}

<div class="illustration-tabs" id="illustration-{{ $uid }}">
  <style>
    .illustration-tabs .tabs{display:flex;gap:8px;margin-bottom:8px}
    .illustration-tabs .tabs button{padding:6px 10px;border:1px solid #ddd;background:#f8f8f8;cursor:pointer}
    .illustration-tabs .tabs button.active{background:#fff;border-bottom:2px solid #000}
    .illustration-tabs .panel{display:none}
    .illustration-tabs .panel.active{display:block}
    .illustration-tabs img{max-width:100%;height:auto;display:block}
  </style>

  <div class="tabs" role="tablist">
    <button type="button" class="tab-btn" data-tab="image">Image</button>
    {{- if $youtubeID }}<button type="button" class="tab-btn" data-tab="youtube">YouTube</button>{{- end }}
    {{- if $facebookID }}<button type="button" class="tab-btn" data-tab="facebook">Facebook Reel</button>{{- end }}
  </div>

  <div class="panels">
    {{- /* Image panel: render illustration.webp using site.image_host or site.BaseURL */ -}}
    {{- $imgHost := (site.Params.image_host | default (replaceRE `/$` "" site.BaseURL)) -}}
    {{- $imgPath := "illustration.webp" -}}
    {{- if findRE `^/` $imgPath -}}
      {{- $imgSrc := printf "%s%s" $imgHost $imgPath -}}
    {{- else -}}
      {{- $imgSrc := printf "%s/%s" $imgHost $imgPath -}}
    {{- end -}}
    {{- /* Choose whichever computed $imgSrc is in scope for rendering */ -}}
    {{- $imgSrc := cond (findRE `^/` $imgPath) (printf "%s%s" $imgHost $imgPath) (printf "%s/%s" $imgHost $imgPath) -}}

    <div class="panel panel-image" data-panel="image">
      {{ partial "figure.html" (dict "Page" $page.Page "src" $imgSrc "class" "illustration-image") }}
    </div>

    {{- if $youtubeID }}
      <div class="panel panel-youtube" data-panel="youtube">
          {{ partial "youtube.html" (dict "Page" $page.Page "id" $youtubeID "width" "560" "height" "315" "lazy" true) }}
      </div>
    {{- end }}

    {{- if $facebookID }}
      <div class="panel panel-facebook" data-panel="facebook">
        {{ partial "fb-video.html" (dict "Page" $page.Page "id" $facebookID "width" "560" "height" "315" "lazy" true) }}
      </div>
    {{- end }}
  </div>

  <script>
    (function(){
      var root = document.getElementById('illustration-{{ $uid }}');
      if(!root) return;
      var buttons = root.querySelectorAll('.tab-btn');
      var panels = root.querySelectorAll('.panel');
      function loadIframesIn(panel){
        var ifr = panel.querySelectorAll('iframe[data-src]');
        ifr.forEach(function(i){
          if(!i.getAttribute('src')){
            i.setAttribute('src', i.getAttribute('data-src'));
            i.setAttribute('data-loaded','1');
          }
        });
      }

      function activate(name){
        buttons.forEach(function(b){ b.classList.toggle('active', b.dataset.tab===name); });
        panels.forEach(function(p){ p.classList.toggle('active', p.dataset.panel===name); });
        // load iframes for the newly active panel
        var activePanel = root.querySelector('.panel.active');
        if(activePanel) loadIframesIn(activePanel);
      }
      var defaultTab = '{{ $default }}';
      // If default not available on page, fallback to image
      var available = Array.prototype.map.call(buttons, function(b){ return b.dataset.tab; });
      if(available.indexOf(defaultTab)===-1) defaultTab='image';
      // attach handlers
      buttons.forEach(function(b){ b.addEventListener('click', function(){ activate(b.dataset.tab); }); });
      // activate default and load its iframes
      activate(defaultTab);
    })();
  </script>
</div>
