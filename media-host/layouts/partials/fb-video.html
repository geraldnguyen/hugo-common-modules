{{- /*
  Partial: fb-video.html
  Accepts a dict context with keys: Page, id, pos0, width, height, class, title, loading
  Lookup for id: index . "id" -> Page.Params.facebook_video_id -> index . "pos0"
*/ -}}

{{- $ctx := . -}}
{{- $page := index $ctx "Page" -}}
{{- $idIn := index $ctx "id" -}}
{{- $pos0 := index $ctx "pos0" -}}
{{- $fbID := cond (ne $idIn "") $idIn (cond (and $page (ne $page.Params.facebook_video_id "")) $page.Params.facebook_video_id $pos0) -}}

{{- if not $fbID -}}
  {{- $pTitle := "unknown" -}}
  {{- $pURL := "unknown" -}}
  {{- if $page -}}
    {{- if ne $page.Title "" -}}
      {{- $pTitle = $page.Title -}}
    {{- end -}}
    {{- if ne $page.RelPermalink "" -}}
      {{- $pURL = $page.RelPermalink -}}
    {{- else if $page.File -}}
      {{- $pURL = $page.File.Path -}}
    {{- end -}}
  {{- end -}}
  <!-- fb-video partial skipped: missing id. Page title={{ $pTitle }}, page_url={{ $pURL }} -->
{{- else -}}

{{- $width := or (index $ctx "width") "560" -}}
{{- $height := or (index $ctx "height") "315" -}}
{{- $class := index $ctx "class" -}}
{{- $title := or (index $ctx "title") "Facebook video" -}}
{{- $loading := index $ctx "loading" -}}

{{- $href := "" -}}
{{- if findRE `^https?://` $fbID -}}
  {{- $href = $fbID -}}
{{- else -}}
  {{- $href = printf "https://www.facebook.com/video.php?v=%v" $fbID -}}
{{- end -}}

{{- $src := printf "https://www.facebook.com/plugins/video.php?href=%s&show_text=0&width=%s" (urlquery $href) $width -}}

{{- $lazy := index $ctx "lazy" -}}
{{- $loadingParam := index $ctx "loading" -}}
{{- $loadingAttr := cond (ne $loadingParam "") $loadingParam (cond $lazy "lazy" "") -}}
<div{{ if $class }} class="{{ $class }}"{{ end }}>
  <iframe
    src="{{ $src }}"
    width="{{ $width }}" height="{{ $height }}"
    title="{{ $title }}"
    style="border:none;overflow:hidden"
    scrolling="no"
    frameborder="0"
    allow="autoplay; clipboard-write; encrypted-media; picture-in-picture"
    allowfullscreen
    {{- if ne $loadingAttr "" }} loading="{{ $loadingAttr }}"{{ end -}}
  ></iframe>
</div>
{{- end -}}

